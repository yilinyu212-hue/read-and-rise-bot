name: Read & Rise Auto Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # 每天凌晨自动运行

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install requests feedparser

      - name: Run Crawler
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          APP_TOKEN: ${{ secrets.APP_TOKEN }}
          TABLE_ID: ${{ secrets.TABLE_ID }}
        run: python crawler.py

      - name: Deploy to Tencent Cloud
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "data.json,app.py"
          target: "/home/ubuntu/" # 直接同步到网页运行的根目录

      - name: Restart Streamlit Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            fuser -k 8501/tcp || true
            nohup streamlit run /home/ubuntu/app.py --server.address 0.0.0.0 &
